# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: Run Tests

on:
  # via github UI
  workflow_dispatch:
  # schedule:
  #   - cron: '18 20 * * *'
  push:
    branches: ["*"]
    # Publish semver tags as releases.
    tags: ["v*.*.*"]
  pull_request:
    branches: ["develop", "main"]

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Prepare test environment
        run: |
          cat - <<EOF > env-example
          DOMAIN=kube.eoepca.org
          KEYCLOAK=keycloak.\${DOMAIN}
          EOF
      - name: Check env (DEBUG)
        run: |
          cat env-example
      - name: Check mount (DEBUG)
        run: |
          docker run --rm -t \
            -e target=example \
            -v ./env-example:/work/test/.env.example \
            eoepca/system-test \
            cat test/.env.example
      - name: Invoke pytest
        run: |
          docker run --rm -t \
            -e target=example \
            -v ./env-example:/work/test/.env.example \
            -v ./out:/work/out \
            eoepca/system-test \
            pytest test -v --junit-xml=out/report.xml
      - name: Check report
        run: |
          cat out/report.xml
